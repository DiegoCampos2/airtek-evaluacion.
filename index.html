<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airtek Cloud - Sistema de Evaluación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIREBASE LIBRARIES -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* ESTILOS DE IMPRESIÓN MEJORADOS */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            #print-report { display: block !important; }
            .card-border { border: 1px solid #cbd5e1; padding: 12px; margin-bottom: 8px; border-radius: 6px; break-inside: avoid; }
            /* Espacio forzado para firmas */
            .signature-area { margin-top: 150px !important; } 
        }
        #print-report { display: none; }

        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 14px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .btn-primary { background: #2563eb; color: white; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.97); }
        
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Estado de Conexión -->
    <div id="status-bar" class="fixed bottom-4 right-4 z-[100] flex items-center gap-2 bg-slate-900 px-3 py-1.5 rounded-full border border-slate-700 shadow-xl no-print transition-all">
        <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
        <span id="status-text" class="text-[9px] font-black tracking-widest text-slate-400">CONECTANDO...</span>
    </div>

    <!-- UI Principal -->
    <div id="app-container" class="min-h-screen pb-20 no-print">
        <header class="p-5 flex justify-between items-center bg-[#020617]/90 sticky top-0 z-50 border-b border-white/5 backdrop-blur-xl">
            <div>
                <h1 class="text-lg font-black tracking-tighter text-white">AIRTEK <span class="text-blue-500">CLOUD</span></h1>
                <p class="text-[8px] font-bold text-slate-500 uppercase tracking-widest">Sistema Centralizado v3.0</p>
            </div>
            <button onclick="toggleAdmin()" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 hover:bg-slate-700 transition-colors">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            </button>
        </header>

        <main class="p-4 max-w-xl mx-auto space-y-6">
            
            <!-- VISTA 1: HOME -->
            <section id="s-home" class="space-y-4 pt-2">
                <div class="glass p-6 rounded-[2rem] space-y-5 border-t border-white/10 shadow-2xl">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-600 w-1 h-4 rounded-full"></div>
                        <h2 class="text-xs font-black text-slate-300 uppercase tracking-widest">Perfil del Candidato</h2>
                    </div>
                    <input id="in-name" type="text" placeholder="Nombre y Apellido">
                    <input id="in-id" type="tel" placeholder="Cédula de Identidad">
                    <input id="in-job" type="text" placeholder="Cargo Postulado">
                    
                    <div class="pt-4 border-t border-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="bg-slate-600 w-1 h-4 rounded-full"></div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase">Supervisor Responsable</label>
                        </div>
                        <input id="in-eval" type="text" value="Diego Chacin">
                    </div>

                    <button onclick="startApp()" class="w-full btn-primary py-4 rounded-xl font-black shadow-lg shadow-blue-600/20 uppercase tracking-wide text-sm">Iniciar Evaluación</button>
                </div>
            </section>

            <!-- VISTA 2: EXAMEN -->
            <section id="s-exam" class="hidden space-y-4">
                <div class="sticky top-20 z-40 bg-[#020617]/95 py-3 border-b border-white/5 backdrop-blur-md">
                    <div class="flex justify-between text-xs font-bold uppercase text-slate-400 px-2 mb-1">
                        <span>Progreso</span>
                        <span id="txt-prog" class="text-blue-500 font-black">0/20</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div id="bar-prog" class="h-full bg-blue-600 w-0 transition-all duration-300 ease-out"></div>
                    </div>
                </div>
                
                <div id="list-q" class="space-y-5 pb-4"></div>

                <button id="btn-send" onclick="submitData()" class="w-full btn-primary py-5 rounded-2xl font-black text-sm uppercase shadow-xl tracking-wider">
                    Finalizar y Guardar
                </button>
            </section>

            <!-- VISTA 3: RESULTADO (MODO CIEGO) -->
            <section id="s-result" class="hidden text-center py-8">
                <div class="glass p-10 rounded-[2.5rem] border border-blue-500/30 mb-6 relative overflow-hidden">
                    <div class="absolute inset-0 bg-blue-600/5 blur-xl"></div>
                    <div class="relative z-10">
                        <div class="w-28 h-28 mx-auto rounded-full bg-[#020617] border-4 border-blue-600 flex items-center justify-center text-5xl font-black text-white mb-4 shadow-[0_0_30px_rgba(37,99,235,0.4)]">
                            <span id="res-score">0</span>
                        </div>
                        <h2 class="text-2xl font-black text-white uppercase tracking-tight">Evaluación Finalizada</h2>
                        <p class="text-slate-400 text-xs mt-2 px-4">Tus respuestas han sido enviadas al servidor de Airtek. El supervisor te indicará los pasos a seguir.</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 text-white p-4 rounded-2xl font-bold text-xs uppercase shadow-lg border border-white/5 transition-all flex flex-col items-center gap-2">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Nueva Evaluación
                    </button>
                </div>
            </section>

            <!-- VISTA 4: ADMIN -->
            <section id="s-admin" class="hidden space-y-4 pt-2">
                <div class="flex justify-between items-center bg-slate-900 p-4 rounded-2xl border border-slate-800">
                    <div>
                        <h2 class="text-xs font-black text-white uppercase tracking-widest">Panel Supervisor</h2>
                        <p class="text-[9px] text-slate-500 mt-1">Conexión: <span class="text-green-500 font-bold">ESTABLE</span></p>
                    </div>
                    <button onclick="exitAdmin()" class="text-red-400 text-[10px] font-bold px-4 py-2 bg-red-500/10 rounded-lg border border-red-500/20 hover:bg-red-500/20 transition-colors">SALIR</button>
                </div>

                <div class="flex gap-2 p-1.5 bg-slate-900 rounded-xl border border-white/5">
                    <button onclick="viewAdmin('history')" id="tab-hist" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase bg-blue-600 text-white shadow-lg transition-all">Historial</button>
                    <button onclick="viewAdmin('editor')" id="tab-edit" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase text-slate-500 hover:text-white transition-all">Config</button>
                </div>

                <div id="view-hist" class="space-y-3 max-h-[60vh] overflow-y-auto pb-10">
                    <div class="text-center py-12">
                        <div class="loader mb-3 border-slate-600 border-t-blue-500"></div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Sincronizando registros...</p>
                    </div>
                </div>

                <div id="view-edit" class="hidden space-y-4 pb-10">
                    <button onclick="saveConfig()" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-black text-xs uppercase shadow-lg transition-all">Guardar Configuración</button>
                    <div id="edit-list" class="space-y-4"></div>
                </div>
            </section>

        </main>
    </div>

    <!-- FORMATO DE IMPRESIÓN (OCULTO) -->
    <div id="print-report" class="p-10 max-w-4xl mx-auto">
        <!-- Encabezado -->
        <div style="border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h1 style="font-size: 28pt; font-weight: 900; color: #2563eb; margin:0; letter-spacing: -1px;">AIRTEK</h1>
                <p style="font-size: 10pt; font-weight: bold; color: #64748b; letter-spacing: 2px;">ENERGÍA Y MONITOREO</p>
            </div>
            <div style="text-align: right;">
                <h2 style="font-size: 16pt; font-weight: 900; margin:0; color: #1e293b;">REPORTE TÉCNICO</h2>
                <p id="pr-date" style="font-size: 11pt; color: #64748b;"></p>
            </div>
        </div>

        <!-- Datos -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 30px;">
            <div>
                <p style="font-size: 8pt; color: #94a3b8; font-weight: 900; margin-bottom: 8px; letter-spacing: 1px;">DATOS DEL CANDIDATO</p>
                <p id="pr-cand" style="font-size: 14pt; font-weight: 900; text-transform: uppercase; color: #0f172a;"></p>
                <p id="pr-id" style="font-size: 11pt; font-family: monospace; color: #334155; margin-top: 2px;"></p>
                <p id="pr-job" style="font-size: 11pt; margin-top: 2px; color: #334155;"></p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 8pt; color: #94a3b8; font-weight: 900; margin-bottom: 8px; letter-spacing: 1px;">SUPERVISOR</p>
                <p id="pr-eval" style="font-size: 14pt; font-weight: 900; text-transform: uppercase; color: #0f172a;"></p>
                <div style="margin-top: 15px; background: #2563eb; color: white; display: inline-block; padding: 5px 15px; border-radius: 6px;">
                    <span style="font-size: 12pt; font-weight: bold;">NOTA: </span>
                    <span id="pr-score" style="font-size: 18pt; font-weight: 900;"></span>
                    <span style="font-size: 12pt;">/20</span>
                </div>
            </div>
        </div>

        <!-- Lista de Preguntas -->
        <div id="pr-list" style="font-size: 10pt; color: #1e293b;"></div>

        <!-- Firmas (ESPACIO AMPLIADO) -->
        <div class="signature-area" style="margin-top: 150px; display: grid; grid-template-columns: 1fr 1fr; gap: 80px; text-align: center;">
            <div style="border-top: 2px solid #000; padding-top: 15px;">
                <p style="font-size: 9pt; font-weight: 900; letter-spacing: 1px;">FIRMA DEL CANDIDATO</p>
            </div>
            <div style="border-top: 2px solid #000; padding-top: 15px;">
                <p style="font-size: 9pt; font-weight: 900; letter-spacing: 1px;">FIRMA Y SELLO DEL SUPERVISOR</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE PROPORCIONADA
        const firebaseConfig = {
            apiKey: "AIzaSyAQk7SmO2BJQl_Bnx-87Sw07ivn5_17njo",
            authDomain: "airtek-system.firebaseapp.com",
            projectId: "airtek-system",
            storageBucket: "airtek-system.firebasestorage.app",
            messagingSenderId: "721754246724",
            appId: "1:721754246724:web:a38a0b57e3f364d7947611"
        };

        const appId = 'airtek-produccion'; 
        const ADMIN_PASS = "885500";
        let db, auth;
        let globalHistory = []; // Almacena historial para impresión

        // Preguntas (Respaldo)
        let questions = [
            { id: 1, text: "¿Qué se debe tomar en cuenta para calcular la carga conectada en las fuentes Huawei ETP23006?", options: [{id:'a',text:"Carga mostrada en la entrada AC"},{id:'b',text:"Banco cargado, Inversores, Rectificadores y SSU"},{id:'c',text:"Banco descargado, Inversores, Rectificadores y SSU"},{id:'d',text:"Carga mostrada en los inversores"}], correct: 'b' },
            { id: 2, text: "¿Voltaje máximo que puede operar la batería Pylontech US5000 según el manual?", options: [{id:'a',text:"50 V"},{id:'b',text:"48 V"},{id:'c',text:"53.5 V"},{id:'d',text:"51 V"}], correct: 'c' },
            { id: 3, text: "¿Cuáles son las etapas de carga de una batería?", options: [{id:'a',text:"Absorción, flotación y carga inicial"},{id:'b',text:"Descarga, reposo y ecualización"},{id:'c',text:"Saturación, corte por voltaje y temperatura"},{id:'d',text:"Corriente constante, voltaje variable e inducción"}], correct: 'a' },
            { id: 4, text: "Para calcular la autonomía de un banco de baterías, ¿qué se debe tomar en cuenta?", options: [{id:'a',text:"Voltaje máximo de operación, carga conectada, ciclos de vida de la batería."},{id:'b',text:"Estado de salud del banco, profundidad de descarga, amperios horas nominal."},{id:'c',text:"Voltaje nominal, amperios horas nominal, profundidad de descarga, carga conectada, factores de conversión, temperatura y estado de salud."},{id:'d',text:"Carga conectada, voltaje nominal y factor de conversión."}], correct: 'c' },
            { id: 5, text: "En caso de que un módulo Deep Sea no ingrese desde el programa pero sí se le puede hacer ping y entrar a la web, ¿qué se debe hacer antes de informar?", options: [{id:'a',text:"Nada, informar inmediatamente."},{id:'b',text:"Formatear el módulo."},{id:'c',text:"Resetear el módulo."},{id:'d',text:"Obviar lo visto porque no es nada de gravedad."}], correct: 'c' },
            { id: 6, text: "En caso de ocurrir un apagón general (Blackout), ¿qué se debe hacer?", options: [{id:'a',text:"Nada, esperar que todo normalice."},{id:'b',text:"Validar el documento orientado al blackout e informar a los involucrados."},{id:'c',text:"Solo llamar a tu supervisor inmediato."},{id:'d',text:"Solo registrar el evento en el registro."}], correct: 'b' },
            { id: 7, text: "¿Desde qué plataforma se puede observar la carga conectada de los inversores MPP Solar?", options: [{id:'a',text:"Solar Guardian"},{id:'b',text:"Shinephone"},{id:'c',text:"Plataforma Growatt"},{id:'d',text:"WatchPower"}], correct: 'd' },
            { id: 8, text: "Para poder verificar el porcentaje real de una batería Pylontech en un Victron, ¿qué equipo debe estar conectado?", options: [{id:'a',text:"Cerbo GX"},{id:'b',text:"Módulo Wifi genérico"},{id:'c',text:"No es posible ya que no es compatible con el equipo"},{id:'d',text:"Módulo SMU"}], correct: 'a' },
            { id: 9, text: "¿A qué nivel de voltaje mínimo del banco de baterías de LFP (Litio) debe el personal operativo dirigirse al nodo a validar una posible afectación?", options: [{id:'a',text:"57 V"},{id:'b',text:"52 V"},{id:'c',text:"47 V"},{id:'d',text:"49 V"}], correct: 'd' },
            { id: 10, text: "La alarma \"AC-PTOFIJO-INV01 APAGADO\" ¿se debe a que...?", options: [{id:'a',text:"El inversor perdió entrada AC."},{id:'b',text:"Falso positivo."},{id:'c',text:"Inversor sin salida AC."},{id:'d',text:"Planta en reposo."}], correct: 'c' },
            { id: 11, text: "En las fuentes Huawei ETP23006, ¿cuántos módulos SSU pueden conectarse en la segunda fila?", options: [{id:'a',text:"2"},{id:'b',text:"3"},{id:'c',text:"1"},{id:'d',text:"5"}], correct: 'a' },
            { id: 12, text: "Aparte de los inversores, fuentes y plantas eléctricas, ¿qué es importante monitorear en un nodo?", options: [{id:'a',text:"Cámaras"},{id:'b',text:"Climatización"},{id:'c',text:"Movimiento en sitio"},{id:'d',text:"Equipos de redes"}], correct: 'b' },
            { id: 13, text: "¿Cuál es la función de los Módulos DSE855?", options: [{id:'a',text:"Monitoreo y control remoto de las Plantas Eléctricas"},{id:'b',text:"Monitoreo de las fuentes ETP23006"},{id:'c',text:"Monitoreo de los inversores Growatt"},{id:'d',text:"Monitoreo de los módulos solares"}], correct: 'a' },
            { id: 14, text: "¿A qué nivel de voltaje mínimo del banco de baterías de Litio NMC debe el personal operativo dirigirse al nodo a validar una posible afectación?", options: [{id:'a',text:"57 V"},{id:'b',text:"45 V"},{id:'c',text:"51 V"},{id:'d',text:"54 V"}], correct: 'c' },
            { id: 15, text: "¿A qué nivel de voltaje mínimo del banco de baterías de gel 4S al cual el personal operativo debe dirigirse al nodo a validar una posible afectación?", options: [{id:'a',text:"54 V"},{id:'b',text:"51 V"},{id:'c',text:"42 V"},{id:'d',text:"49 V"}], correct: 'd' },
            { id: 16, text: "Si la frecuencia o el voltaje de los inversores están fuera del rango de operación (observado en Grafana) ¿qué ocurre?", options: [{id:'a',text:"Nada, puede operar con normalidad."},{id:'b',text:"Se desconecta de la entrada AC y no carga el banco de baterías."},{id:'c',text:"Se desconecta de la entrada AC y sigue cargando el banco de baterías."},{id:'d',text:"Inversor se apaga."}], correct: 'b' },
            { id: 17, text: "Si una planta eléctrica no enciende en su tiempo de delay y ya se verificó en el Deep Sea que está alarmada ¿Qué se debe hacer?", options: [{id:'a',text:"Informar a soporte IP"},{id:'b',text:"Validar paneles solares"},{id:'c',text:"Informar a personal operativo y al grupo creado llamado \"Eventualidades grupo electrógeno\"."},{id:'d',text:"Informar a personal operativo y personal de redes"}], correct: 'c' },
            { id: 18, text: "Cada vez que se inicia guardia, ¿cuál es el procedimiento a seguir?", options: [{id:'a',text:"Informarle a tu supervisor el inicio de guardia."},{id:'b',text:"Nada, continuar con la guardia con normalidad."},{id:'c',text:"Verificar el reporte y realizar recorrido de la sede, y aplicar la revisión pertinente de todo."},{id:'d',text:"Solo firmar el libro de novedades sin revisar nada."}], correct: 'c' },
            { id: 19, text: "Si el personal de soporte IP o clientes dedicados informa que una de las fuentes está apagada, ¿cómo se validaría que no están apagados por completo los equipos de redes?", options: [{id:'a',text:"Verificar en Solar Guardian los equipos conectados e informar al supervisor inmediato."},{id:'b',text:"Verificar en el grupo de Telegram todas las alarmas para validar los equipos de redes e informar al grupo de \"eventualidades foráneos\"."},{id:'c',text:"Validar plataforma de inversores / Fuentes e informar al supervisor inmediato de ser necesario."},{id:'d',text:"Nada porque es algo que ocurre normalmente."}], correct: 'c' },
            { id: 20, text: "¿De enviar un evento donde se ve afectado un Nodo por el grupo de Averías Mayores, qué se debe hacer?", options: [{id:'a',text:"Nada"},{id:'b',text:"Verificar los mensajes predeterminados para enviar el que esté acorde a lo reportado y notificar a supervisor."},{id:'c',text:"Informar solo a la dirección sobre la situación"},{id:'d',text:"Informar a Soporte IP"}], correct: 'b' }
        ];

        let userAnswers = {};
        
        // --- INICIALIZACIÓN ---
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            auth.onAuthStateChanged(user => {
                if(user) {
                    statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
                    statusText.textContent = "EN LÍNEA";
                    // Cargar preguntas
                    db.doc(`artifacts/${appId}/public/data/config/main`).get()
                    .then(doc => { if(doc.exists() && doc.data().questions) questions = doc.data().questions; })
                    .catch(e => console.log("Usando configuración local"));
                } else {
                    auth.signInAnonymously().catch(e => console.error(e));
                }
            });
        } catch(e) {
            console.warn("Modo Offline");
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-red-500";
            document.getElementById('status-text').textContent = "OFFLINE";
        }

        // --- UI ---
        function startApp() {
            if(!document.getElementById('in-name').value) return alert("Faltan datos");
            document.getElementById('s-home').classList.add('hidden');
            document.getElementById('s-exam').classList.remove('hidden');
            renderQuestions();
            updateProgress();
        }

        function renderQuestions() {
            document.getElementById('list-q').innerHTML = questions.map((q, i) => `
                <div class="glass p-5 rounded-2xl space-y-4 animate-in">
                    <h3 class="text-xs font-black text-white uppercase"><span class="text-blue-500 mr-2">#${i+1}</span>${q.text}</h3>
                    <div class="space-y-2">
                        ${q.options.map(opt => `
                            <button onclick="selectOpt(${q.id}, '${opt.id}')" id="btn-${q.id}-${opt.id}" class="w-full text-left p-4 rounded-xl bg-slate-900/50 border border-white/5 text-[11px] font-bold text-slate-300 hover:bg-slate-800 transition-all active:scale-95">
                                <span class="text-blue-500 mr-2 uppercase">${opt.id})</span> ${opt.text}
                            </button>
                        `).join('')}
                    </div>
                </div>`).join('');
        }

        function selectOpt(qId, optId) {
            userAnswers[qId] = optId;
            updateProgress();
            questions.find(q => q.id === qId).options.forEach(o => {
                const btn = document.getElementById(`btn-${qId}-${o.id}`);
                btn.className = o.id === optId 
                    ? "w-full text-left p-4 rounded-xl bg-blue-600/20 border border-blue-500 text-[11px] font-bold text-white transition-all shadow-lg shadow-blue-900/20"
                    : "w-full text-left p-4 rounded-xl bg-slate-900/50 border border-white/5 text-[11px] font-bold text-slate-300 hover:bg-slate-800 transition-all opacity-60";
            });
        }

        function updateProgress() {
            const c = Object.keys(userAnswers).length;
            const p = (c / questions.length) * 100;
            document.getElementById('txt-prog').innerText = `${c}/${questions.length}`;
            document.getElementById('bar-prog').style.width = `${p}%`;
        }

        function submitData() {
            if (Object.keys(userAnswers).length < questions.length && !confirm("Faltan preguntas. ¿Enviar igual?")) return;
            const btn = document.getElementById('btn-send');
            btn.disabled = true; btn.innerText = "GUARDANDO...";
            
            let score = 0;
            questions.forEach(q => { if(userAnswers[q.id] === q.correct) score++; });
            
            const payload = {
                nombre: document.getElementById('in-name').value,
                cedula: document.getElementById('in-id').value,
                cargo: document.getElementById('in-job').value,
                evaluador: document.getElementById('in-eval').value,
                score, total: questions.length, respuestas: userAnswers, timestamp: Date.now()
            };

            if(db) {
                db.collection(`artifacts/${appId}/public/data/results`).add(payload)
                .then(() => showResultScreen(score))
                .catch(e => { alert("Error nube: " + e.message); btn.disabled = false; btn.innerText = "REINTENTAR"; });
            } else {
                alert("Sin conexión. No se guardó.");
                showResultScreen(score);
            }
        }

        // Muestra la pantalla "Ciega" al estudiante
        function showResultScreen(score) {
            document.getElementById('s-exam').classList.add('hidden');
            document.getElementById('s-result').classList.remove('hidden');
            document.getElementById('res-score').innerText = score;
            // NOTA: Aquí ya NO generamos el detalle de respuestas para el estudiante.
        }

        // --- ADMIN ---
        function toggleAdmin() {
            if(prompt("Clave:") === ADMIN_PASS) {
                document.getElementById('s-home').classList.add('hidden');
                document.getElementById('s-exam').classList.add('hidden');
                document.getElementById('s-result').classList.add('hidden');
                document.getElementById('s-admin').classList.remove('hidden');
                viewAdmin('history');
            }
        }
        function exitAdmin() {
            document.getElementById('s-admin').classList.add('hidden');
            document.getElementById('s-home').classList.remove('hidden');
        }
        function viewAdmin(tab) {
            document.getElementById('view-hist').classList.add('hidden');
            document.getElementById('view-edit').classList.add('hidden');
            if(tab === 'history') {
                document.getElementById('view-hist').classList.remove('hidden');
                if(db) {
                    db.collection(`artifacts/${appId}/public/data/results`).orderBy('timestamp', 'desc').onSnapshot(snap => {
                        const list = document.getElementById('view-hist');
                        if (snap.empty) { list.innerHTML = '<p class="text-center text-xs text-slate-600">Sin datos</p>'; return; }
                        
                        // Guardamos datos en memoria para poder imprimir
                        globalHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));

                        list.innerHTML = globalHistory.map(r => `
                        <div class="glass p-4 rounded-xl flex justify-between items-center mb-2 border-l-4 border-blue-600">
                            <div>
                                <p class="font-black text-white text-xs uppercase">${r.nombre}</p>
                                <p class="text-[9px] text-slate-500">${new Date(r.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-lg font-black text-white">${r.score}/20</span>
                                <button onclick="printFromHistory('${r.id}')" class="bg-slate-700 p-2 rounded-lg hover:bg-slate-600 border border-slate-600" title="Imprimir Reporte">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                </button>
                            </div>
                        </div>`).join('');
                    });
                }
            } else {
                document.getElementById('view-edit').classList.remove('hidden');
                renderEditor();
            }
        }

        // FUNCIÓN PARA IMPRIMIR DESDE EL HISTORIAL
        function printFromHistory(docId) {
            const data = globalHistory.find(item => item.id === docId);
            if (!data) return alert("Error al cargar datos");

            // Llenar Reporte Oculto
            document.getElementById('pr-date').innerText = new Date(data.timestamp).toLocaleDateString();
            document.getElementById('pr-cand').innerText = data.nombre;
            document.getElementById('pr-id').innerText = data.cedula;
            document.getElementById('pr-job').innerText = data.cargo;
            document.getElementById('pr-eval').innerText = data.evaluador;
            document.getElementById('pr-score').innerText = data.score;
            
            // Reconstruir respuestas
            document.getElementById('pr-list').innerHTML = questions.map((q,i) => {
                const answerId = data.respuestas[q.id];
                const ok = answerId === q.correct;
                const answerText = q.options.find(o=>o.id===answerId)?.text || '---';
                
                return `<div class="card-border">
                    <p><strong>${i+1}. ${q.text}</strong></p>
                    <p style="color:${ok?'green':'red'}">R: ${answerText}</p>
                    ${!ok ? `<p style="font-size:8pt;color:green;margin-top:2px;">Correcta: ${q.options.find(o=>o.id===q.correct).text}</p>` : ''}
                </div>`;
            }).join('');

            // Ejecutar impresión
            window.print();
        }

        function renderEditor() {
            document.getElementById('edit-list').innerHTML = questions.map((q, i) => `
                <div class="glass p-4 rounded-xl space-y-2">
                    <div class="flex justify-between"><span class="text-[10px] font-black text-blue-500">P #${q.id}</span>
                    <select onchange="questions[${i}].correct=this.value" class="p-1 rounded bg-slate-800 text-[10px]"><option value="a" ${q.correct=='a'?'selected':''}>A</option><option value="b" ${q.correct=='b'?'selected':''}>B</option><option value="c" ${q.correct=='c'?'selected':''}>C</option><option value="d" ${q.correct=='d'?'selected':''}>D</option></select></div>
                    <textarea onchange="questions[${i}].text=this.value" class="text-xs font-bold bg-black/30">${q.text}</textarea>
                </div>`).join('');
        }
        function saveConfig() {
            if(db) {
                db.doc(`artifacts/${appId}/public/data/config/main`).set({ questions })
                .then(() => alert("Guardado en Nube OK"))
                .catch(e => alert("Error: " + e.message));
            }
        }
    </script>
</body>
</html>
